services:
    php-fpm:
        build: docker
        container_name: 'dp-php'
        volumes:
            - ./app:/app
        working_dir: /app

    nginx:
        image: nginx
        container_name: 'dp-nginx'
        working_dir: /app
        ports:
            - '29998:80'
        volumes:
            - ./:/app
            - ./docker/nginx.conf:/etc/nginx/conf.d/default.conf
            - ./docker/nginx/logs:/var/log/nginx:delegated

    gitlab:
        image: gitlab/gitlab-ee:latest
        container_name: gitlab
        restart: always
        hostname: 'gitlab.local'
        environment:
            GITLAB_OMNIBUS_CONFIG: |
                external_url 'http://gitlab.local:7778'
                gitlab_rails['gitlab_shell_ssh_port'] = 9022
        ports:
            - '7778:7778'
            - '9022:22'
        volumes:
            - dp_gitlab_config:/etc/gitlab
            - dp_gitlab_logs:/var/log/gitlab
            - dp_gitlab_data:/var/opt/gitlab
        shm_size: '256m'

    gitlab-runner:
        image: gitlab/gitlab-runner:latest
        container_name: gitlab-runner
        restart: always

volumes:
    dp_gitlab_config:
    dp_gitlab_logs:
    dp_gitlab_data:
